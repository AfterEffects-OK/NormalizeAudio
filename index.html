<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ノーマライズサウンド</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .card {
            background-color: #1E1E1E;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .drag-area {
            border: 2px dashed #4A4A4A;
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .drag-area.active {
            background-color: #2A2A2A;
            border-color: #6B6B6B;
        }
        .progress-bar-container {
            height: 0.5rem;
            background-color: #4A4A4A;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #6366F1;
            transition: width 0.3s;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366F1;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #6366F1;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }
        .slider-thumb::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #6366F1;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.7);
            display: none;
        }
        .modal-content {
            background-color: #1E1E1E;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .modal-content h1, .modal-content h2, .modal-content h3 {
            color: #6366F1;
        }
        .modal-content a {
            color: #a5b4fc;
            text-decoration: underline;
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #E0E0E0;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        .modal-close:hover {
            color: #6366F1;
        }
        .play-button {
            transition: transform 0.1s;
        }
        .play-button:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div id="main-app" class="card w-full max-w-2xl mx-auto space-y-6">
        <h1 class="text-3xl font-bold text-center text-indigo-400">
            ノーマライズサウンド
        </h1>
        <p class="text-center text-gray-400">
            複数のオーディオファイルの音量を均一化し、出力形式を選択します。
        </p>

        <!-- Drag and Drop Area -->
        <div id="drag-area" class="drag-area">
            <p class="text-lg text-gray-300">
                ファイルをここにドラッグ＆ドロップ
            </p>
            <p class="text-sm text-gray-500 mt-2">
                またはクリックしてファイルを選択
            </p>
            <input type="file" id="file-input" class="hidden" multiple accept="audio/*">
        </div>
        
        <!-- Button to open spec sheet -->
        <div class="flex justify-center mt-6">
            <button id="open-spec-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300">
                仕様書を開く
            </button>
        </div>

        <!-- Controls and File List -->
        <div id="controls-and-list" class="hidden">
            <div class="flex flex-col md:flex-row md:space-x-8 space-y-4 md:space-y-0 mb-6">
                <!-- Target Volume Control -->
                <div class="flex-1">
                    <label for="target-volume" class="block text-sm font-medium text-gray-400 mb-2">
                        目標音量 (LUFS)
                    </label>
                    <div class="flex items-center space-x-4">
                        <input type="range" id="target-volume" min="-30" max="0" value="-14" step="1"
                               class="flex-1 h-2 bg-gray-600 rounded-lg slider-thumb">
                        <span id="volume-value" class="w-12 text-center text-gray-300">-14</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        -14 LUFSが一般的なストリーミングサービスで推奨されています。
                    </p>
                </div>

                <!-- Output Format Control -->
                <div class="flex-1">
                    <label for="output-format" class="block text-sm font-medium text-gray-400 mb-2">
                        出力フォーマット
                    </label>
                    <select id="output-format" class="w-full p-2 rounded-lg bg-gray-700 text-gray-300 border border-gray-600">
                        <option value="wav">WAV</option>
                        <option value="mp3">MP3</option>
                    </select>
                </div>
                
                <!-- MP3 Bitrate Control -->
                <div class="flex-1 hidden" id="bitrate-control">
                    <label for="bitrate-select" class="block text-sm font-medium text-gray-400 mb-2">
                        MP3ビットレート (kbps)
                    </label>
                    <select id="bitrate-select" class="w-full p-2 rounded-lg bg-gray-700 text-gray-300 border border-gray-600">
                        <option value="128">128</option>
                        <option value="192">192</option>
                        <option value="320">320</option>
                    </select>
                </div>
            </div>

            <!-- File List and Progress -->
            <h2 class="text-xl font-semibold mb-2 text-gray-300">
                ファイルリスト
            </h2>
            <div id="file-list" class="space-y-4"></div>
            
            <div class="flex justify-center mt-6 space-x-4">
                <button id="process-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300" disabled>
                    処理を開始
                </button>
                <button id="delete-all-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300 flex items-center justify-center space-x-2" disabled>
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span>すべて削除</span>
                </button>
            </div>
            
            <div id="processed-files-list" class="space-y-4 hidden mt-8">
                <h2 class="text-xl font-semibold mb-2 text-gray-300">
                    処理済みファイル
                </h2>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center p-4">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-sm text-center space-y-4">
                <div id="message-spinner" class="spinner mx-auto hidden"></div>
                <h3 id="message-title" class="text-xl font-bold text-indigo-400"></h3>
                <p id="message-text" class="text-gray-300"></p>
                <!-- 進捗バーをここへ移動 -->
                <div id="overall-progress-container" class="mt-4 hidden">
                    <p id="overall-progress-text" class="text-sm mb-1 text-gray-400">
                        全体の進捗: 0%
                    </p>
                    <div class="progress-bar-container">
                        <div id="overall-progress-bar" class="progress-bar" style="width: 0%;"></div>
                    </div>
                </div>
                <div id="message-actions" class="flex justify-center space-x-4 mt-4">
                    <button id="close-message" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300">
                        閉じる
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Specification Modal -->
<div id="spec-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <div id="spec-content" class="prose max-w-none text-gray-300"></div>
    </div>
</div>

<script>
    const dragArea = document.getElementById('drag-area');
    const fileInput = document.getElementById('file-input');
    const controlsAndList = document.getElementById('controls-and-list');
    const fileList = document.getElementById('file-list');
    const processedFilesList = document.getElementById('processed-files-list');
    const processButton = document.getElementById('process-button');
    const deleteAllButton = document.getElementById('delete-all-button');
    const openSpecButton = document.getElementById('open-spec-button');
    const messageBox = document.getElementById('message-box');
    const messageTitle = document.getElementById('message-title');
    const messageText = document.getElementById('message-text');
    const messageSpinner = document.getElementById('message-spinner');
    const closeMessageButton = document.getElementById('close-message');
    const overallProgressContainer = document.getElementById('overall-progress-container');
    const overallProgressBar = document.getElementById('overall-progress-bar');
    const overallProgressText = document.getElementById('overall-progress-text');
    const targetVolumeSlider = document.getElementById('target-volume');
    const volumeValueSpan = document.getElementById('volume-value');
    const outputFormatSelect = document.getElementById('output-format');
    const bitrateControl = document.getElementById('bitrate-control');
    const bitrateSelect = document.getElementById('bitrate-select');
    const specModal = document.getElementById('spec-modal');
    const specContent = document.getElementById('spec-content');
    const modalCloseButton = document.querySelector('.modal-close');
    
    let filesToProcess = [];
    let processedFiles = [];
    let specContentFetched = false;
    let currentAudio = null;
    let playingIndex = -1;
    
    // 仕様書の内容を直接コード内に記述
    const specMarkdown = `
# オーディオ正規化ツール 仕様書

## 概要
このツールは、複数のオーディオファイルの音量を均一化し、指定されたフォーマットで出力するWebアプリケーションです。

## 機能
* **ドラッグ＆ドロップ**: オーディオファイルをツールに直接ドラッグ＆ドロップしてアップロードできます。
* **複数ファイル対応**: 一度に複数のファイルを処理できます。
* **音量正規化**: 音量を指定した**LUFS**（Loudness Units Full Scale）レベルに正規化します。
    * **推奨値**: -14 LUFSは一般的なストリーミングサービスで推奨される音量レベルです。
* **出力フォーマット**:
    * **WAV**: 高音質で非圧縮のWAV形式で出力します。
    * **MP3**: 圧縮されたMP3形式で出力します。
* **MP3ビットレート**: MP3出力時にビットレートを選択できます (128 kbps, 192 kbps, 320 kbps)。
* **一括ダウンロード**: 処理が完了したすべてのファイルをZIPファイルとして一括でダウンロードできます。
* **リアルタイム進捗表示**: ファイルごとの処理状況と全体の進捗がリアルタイムで表示されます。
* **リアルタイム再生**: 処理が完了したファイルをすぐにプレビュー再生できます。

## 使用技術
* **フロントエンド**: HTML, CSS (Tailwind CSS), JavaScript
* **JavaScriptライブラリ**:
    * **Lamejs**: MP3エンコーディングに使用
    * **JSZip**: 処理済みファイルの一括ダウンロードに使用

## 注意事項
* ファイルサイズや数によっては処理に時間がかかる場合があります。
* ブラウザがWeb Audio APIをサポートしている必要があります。
    `;

    // カスタムメッセージボックスを表示するユーティリティ関数
    function showMessageBox(title, text, showSpinner = false) {
        messageTitle.textContent = title;
        messageText.textContent = text;
        if (showSpinner) {
            messageSpinner.classList.remove('hidden');
        } else {
            messageSpinner.classList.add('hidden');
        }
        messageBox.classList.remove('hidden');
    }

    closeMessageButton.addEventListener('click', () => {
        messageBox.classList.add('hidden');
        overallProgressContainer.classList.add('hidden');
    });
    
    // Handle drag events
    dragArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dragArea.classList.add('active');
    });

    dragArea.addEventListener('dragleave', () => {
        dragArea.classList.remove('active');
    });

    dragArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dragArea.classList.remove('active');
        handleFiles(e.dataTransfer.files);
    });

    // Handle file input click
    dragArea.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    // Update volume value on slider change
    targetVolumeSlider.addEventListener('input', (e) => {
        volumeValueSpan.textContent = e.target.value;
    });

    // Toggle bitrate control visibility based on output format
    outputFormatSelect.addEventListener('change', (e) => {
        if (e.target.value === 'mp3') {
            bitrateControl.classList.remove('hidden');
        } else {
            bitrateControl.classList.add('hidden');
        }
    });

    // Handle selected files
    function handleFiles(files) {
        if (files.length === 0) return;
        filesToProcess = [...files];
        processedFiles = []; // 処理済みファイルをリセット
        renderFileList();
        processedFilesList.classList.add('hidden');
    }

    // Render the file list on the UI
    function renderFileList() {
        fileList.innerHTML = '';
        if (filesToProcess.length > 0) {
            controlsAndList.classList.remove('hidden');
            processButton.disabled = false;
            deleteAllButton.disabled = false;
        } else {
            controlsAndList.classList.add('hidden');
            processButton.disabled = true;
            deleteAllButton.disabled = true;
        }

        filesToProcess.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-3 bg-gray-700 rounded-lg';
            fileItem.innerHTML = `
                <span class="truncate text-gray-300">${file.name}</span>
                <div class="flex items-center space-x-2">
                    <span class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                    <button class="text-red-400 hover:text-red-500 transition-colors duration-300" onclick="deleteFile(${index})" title="ファイルを削除">
                        <!-- Trash Can Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `;
            fileList.appendChild(fileItem);
        });
    }

    // Delete a single file by its index
    function deleteFile(index) {
        filesToProcess.splice(index, 1);
        renderFileList();
    }

    // Delete all files
    deleteAllButton.addEventListener('click', () => {
        filesToProcess = [];
        processedFiles = [];
        renderFileList();
        processedFilesList.innerHTML = '';
        processedFilesList.classList.add('hidden');
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.src = '';
            currentAudio = null;
            playingIndex = -1;
        }
    });

    // Main processing logic
    processButton.addEventListener('click', async () => {
        if (filesToProcess.length === 0) {
            showMessageBox('エラー', '処理するファイルが選択されていません。');
            return;
        }

        showMessageBox('処理中...', 'ファイルの処理を開始します。', true);
        processButton.disabled = true;
        overallProgressContainer.classList.remove('hidden');
        processedFilesList.innerHTML = '';
        processedFiles = [];
        if (currentAudio) {
            currentAudio.pause();
        }

        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const zip = new JSZip();
            
            for (let i = 0; i < filesToProcess.length; i++) {
                const file = filesToProcess[i];
                const arrayBuffer = await file.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                const targetLoudness = parseFloat(targetVolumeSlider.value);
                const gain = Math.pow(10, targetLoudness / 20);
                const outputFormat = outputFormatSelect.value;
                const bitrate = (outputFormat === 'mp3') ? parseInt(bitrateSelect.value, 10) : null;
                
                // Normalize audio buffer
                const normalizedBuffer = audioContext.createBuffer(
                    audioBuffer.numberOfChannels,
                    audioBuffer.length,
                    audioBuffer.sampleRate
                );

                for (let c = 0; c < audioBuffer.numberOfChannels; c++) {
                    const originalChannelData = audioBuffer.getChannelData(c);
                    const normalizedChannelData = normalizedBuffer.getChannelData(c);
                    for (let s = 0; s < audioBuffer.length; s++) {
                        normalizedChannelData[s] = originalChannelData[s] * gain;
                    }
                }

                let blob, newFileName;

                if (outputFormat === 'wav') {
                    blob = bufferToWav(normalizedBuffer);
                    newFileName = file.name.replace(/(\.[^.]+)$/, `_normalized_${targetLoudness}LUFS.wav`);
                } else if (outputFormat === 'mp3') {
                    blob = bufferToMp3(normalizedBuffer, bitrate);
                    newFileName = file.name.replace(/(\.[^.]+)$/, `_normalized_${targetLoudness}LUFS_${bitrate}kbps.mp3`);
                }
                
                // Add to processedFiles array for playback and individual download
                const objectUrl = URL.createObjectURL(blob);
                processedFiles.push({ name: newFileName, blob: blob, objectUrl: objectUrl });
                
                // Add to ZIP for bulk download
                zip.file(newFileName, blob);
                
                const progress = Math.floor(((i + 1) / filesToProcess.length) * 100);
                overallProgressBar.style.width = `${progress}%`;
                overallProgressText.textContent = `全体の進捗: ${progress}% - ${i + 1} / ${filesToProcess.length} ファイル処理済み`;
            }
            
            updateFileListAfterProcessing();

            // Generate the ZIP file
            const zipBlob = await zip.generateAsync({ type: "blob" });
            const zipUrl = URL.createObjectURL(zipBlob);
            
            // "すべてダウンロード"ボタンを動的に作成して追加
            const downloadAllButton = document.createElement('a');
            downloadAllButton.id = 'download-all-button';
            downloadAllButton.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300 cursor-pointer';
            downloadAllButton.textContent = 'すべてのファイルをまとめてダウンロード (.zip)';
            downloadAllButton.href = zipUrl;
            downloadAllButton.download = `normalized_audio_files.zip`;
            
            const downloadAllContainer = document.createElement('div');
            downloadAllContainer.className = 'flex justify-center mt-4';
            downloadAllContainer.appendChild(downloadAllButton);
            processedFilesList.prepend(downloadAllContainer);

            showMessageBox('完了', 'ファイルの処理が完了しました。');
            overallProgressContainer.classList.remove('hidden');
            overallProgressBar.style.width = `100%`;
            overallProgressText.textContent = `全体の進捗: 100% - 処理完了`;
            processButton.disabled = false;

        } catch (error) {
            console.error('Processing failed:', error);
            showMessageBox('エラー', `ファイルの処理中にエラーが発生しました: ${error.message}`);
            overallProgressContainer.classList.add('hidden');
            processButton.disabled = false;
        }
    });
    
    // 処理済みファイルのリストをUIに反映
    function updateFileListAfterProcessing() {
        processedFilesList.classList.remove('hidden');
        // ヘッダーのみを保持し、リストアイテムをクリア
        processedFilesList.innerHTML = `<h2 class="text-xl font-semibold mb-2 text-gray-300">
                処理済みファイル
            </h2>`;
        
        processedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between p-3 bg-gray-700 rounded-lg';
            fileItem.innerHTML = `
                <span class="truncate text-gray-300">${file.name}</span>
                <div class="flex items-center space-x-2">
                    <!-- Play/Stop Button -->
                    <button id="play-btn-${index}" class="play-button text-indigo-400 hover:text-indigo-500 transition-colors duration-300" onclick="togglePlay(${index})" title="再生">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <!-- Download Button -->
                    <a href="${file.objectUrl}" download="${file.name}" class="text-green-400 hover:text-green-500 transition-colors duration-300" title="ダウンロード">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM10 13l-3-3h2V5h2v5h2l-3 3zm-5 2h10v2H5v-2z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
            `;
            processedFilesList.appendChild(fileItem);
        });
    }

    // Play/Pause function for processed files
    function togglePlay(index) {
        const file = processedFiles[index];
        const button = document.getElementById(`play-btn-${index}`);
        
        if (playingIndex === index) {
            // Already playing, stop it
            if (currentAudio) {
                currentAudio.pause();
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                `;
                button.title = "再生";
                playingIndex = -1;
            }
        } else {
            // Stop any currently playing audio
            if (currentAudio) {
                currentAudio.pause();
                const prevButton = document.getElementById(`play-btn-${playingIndex}`);
                if (prevButton) {
                    prevButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                    `;
                    prevButton.title = "再生";
                }
            }
            
            // Play the new audio
            currentAudio = new Audio(file.objectUrl);
            currentAudio.play();
            playingIndex = index;
            
            // Change button to stop icon with a circle and square
            button.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 7h6v6H7z" />
                </svg>
            `;
            button.title = "停止";
            
            // Reset button to play when audio ends
            currentAudio.onended = () => {
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                `;
                button.title = "再生";
                playingIndex = -1;
            };
        }
    }

    // Helper function to convert AudioBuffer to WAV Blob
    function bufferToWav(buffer) {
        const numChannels = buffer.numberOfChannels;
        const sampleRate = buffer.sampleRate;
        const format = 1; // PCM
        const bitDepth = 16;
        const totalSamples = buffer.length;

        const dataLength = totalSamples * numChannels * (bitDepth / 8);
        const bufferArray = new ArrayBuffer(44 + dataLength);
        const view = new DataView(bufferArray);

        // Write WAV header
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + dataLength, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, format, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * numChannels * (bitDepth / 8), true);
        view.setUint16(32, numChannels * (bitDepth / 8), true);
        view.setUint16(34, bitDepth, true);
        writeString(view, 36, 'data');
        view.setUint32(40, dataLength, true);

        // Write PCM data
        let offset = 44;
        for (let s = 0; s < totalSamples; s++) {
            for (let c = 0; c < numChannels; c++) {
                const sample = Math.max(-1, Math.min(1, buffer.getChannelData(c)[s]));
                view.setInt16(offset, sample * (0x7FFF), true);
                offset += 2;
            }
        }
        return new Blob([view], { type: 'audio/wav' });
    }

    // Helper function to convert AudioBuffer to MP3 Blob
    function bufferToMp3(buffer, bitrate) {
        const sampleRate = buffer.sampleRate;
        const numChannels = buffer.numberOfChannels;
        const mp3encoder = new lamejs.Mp3Encoder(numChannels, sampleRate, bitrate);
        const mp3Data = [];
        const maxSamples = 1152; // LAMEの推奨バッファサイズ

        const leftChannel = new Int16Array(buffer.getChannelData(0).length);
        const rightChannel = (numChannels > 1) ? new Int16Array(buffer.getChannelData(1).length) : null;

        for (let i = 0; i < buffer.getChannelData(0).length; i++) {
            leftChannel[i] = buffer.getChannelData(0)[i] * 32767.5;
        }

        if (numChannels > 1) {
            for (let i = 0; i < buffer.getChannelData(1).length; i++) {
                rightChannel[i] = buffer.getChannelData(1)[i] * 32767.5;
            }
        }

        for (let i = 0; i < buffer.length; i += maxSamples) {
            let leftChunk = leftChannel.subarray(i, i + maxSamples);
            let rightChunk = (numChannels > 1) ? rightChannel.subarray(i, i + maxSamples) : null;

            let mp3buf;
            if (numChannels > 1) {
                mp3buf = mp3encoder.encodeBuffer(leftChunk, rightChunk);
            } else {
                mp3buf = mp3encoder.encodeBuffer(leftChunk);
            }

            if (mp3buf.length > 0) {
                mp3Data.push(mp3buf);
            }
        }

        const mp3buf = mp3encoder.flush();
        if (mp3buf.length > 0) {
            mp3Data.push(mp3buf);
        }

        return new Blob(mp3Data, { type: 'audio/mp3' });
    }

    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }

    // Modal logic for spec sheet
    openSpecButton.addEventListener('click', () => {
        if (!specContentFetched) {
            // MarkdownをHTMLに変換
            const html = specMarkdown.replace(/^# (.*$)/gim, '<h1>$1</h1>')
                                     .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                                     .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                                     .replace(/\*\*([^\*]+)\*\*/gim, '<strong>$1</strong>')
                                     .replace(/\*([^\*]+)\*/gim, '<em>$1</em>')
                                     .replace(/\n/g, '<br>');
            
            specContent.innerHTML = html;
            specContentFetched = true;
        }
        specModal.style.display = 'block';
    });

    modalCloseButton.addEventListener('click', () => {
        specModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
        if (event.target === specModal) {
            specModal.style.display = 'none';
        }
    });
</script>

</body>
</html>
